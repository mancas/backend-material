<script>
    var ChatHelper = {
        form: null,
        init: function(form) {
            if (typeof form !== 'object') {
                this.form = document.querySelector('form#' + form);
                if (typeof this.form !== 'object') {
                    console.error('Form does not exists');
                    return;
                }
            }
            this._initSendEvents();
        },

        _initSendEvents: function() {
            var sendBtns = document.querySelectorAll('.send');
            var self = this;

            Array.prototype.forEach.call(sendBtns, function (btn) {
                btn.addEventListener('click', function(evt) {
                    evt.preventDefault();
                    var message = self.form.querySelector('textarea').value;
                    if (message === '') {
                        return;
                    }
                    var path = btn.href;
                    var params = 'msg=' + message;
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', path, true);
                    xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                    xhr.setRequestHeader('Content-length', params.length);
                    xhr.setRequestHeader('Connection', 'close');
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    xhr.send(params);
                    
                    xhr.onload = function () {
                        console.info(xhr.response);
                        var response = JSON.parse(xhr.responseText);
                        if (response.ok) {
                            self.appendMessage(message, response.avatar, response.time);
                            self.form.reset();
                        } else {
                            // Open error notification
                        }
                    };

                    xhr.onreadystatechange = function () {
                        console.info(xhr.readyState);
                    }
                });
            });
        },

        appendMessage: function(message, avatar, time) {
            var list = this.form.parentNode.parentNode.querySelector('ul.list-view');
            var li = document.createElement('li');
            li.className = 'right list-item transparent';
            var img = document.createElement('img');
            img.className = 'list-avatar pull-right';
            img.src = avatar;

            li.appendChild(img);

            var mediaBody = document.createElement('div');
            mediaBody.className = 'media-body';
            var listBubble = document.createElement('div');
            listBubble.className = 'list-bubble';
            var p = document.createElement('p');
            p.textContent = message;

            listBubble.appendChild(p);
            mediaBody.appendChild(listBubble);
            li.appendChild(mediaBody);

            var small = document.createElement('small');
            small.className = 'bubble-date';
            var i = document.createElement('i');
            i.className = 'fa fa-clock-o';

            small.appendChild(i);
            small.innerHTML += time;

            mediaBody.appendChild(small);
            list.appendChild(li);
            // TODO: Look for another way
            setTimeout(function() {
                li.classList.remove('transparent');
                list.scrollTop = list.scrollHeight;
            }, 100);
        }
    }
</script>